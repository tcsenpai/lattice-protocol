---
phase: 01.1-mvp-fix-webui-openapi-search
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/db/schema.sql
  - src/modules/search/index.ts
  - src/modules/search/fts-service.ts
  - src/modules/search/repository.ts
  - src/api/handlers/search.ts
  - src/api/router.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Users can search posts by keyword and get ranked results"
    - "Fuzzy search tolerates typos and returns relevant matches"
    - "Search API returns structured JSON with metadata for AI agents"
    - "FTS5 index is automatically maintained via SQLite triggers"
    - "Search handles malformed queries without crashing"
  artifacts:
    - path: "src/modules/search/index.ts"
      provides: "Search service facade"
      exports: ["searchPosts", "searchAgents"]
      min_lines: 30
    - path: "src/modules/search/fts-service.ts"
      provides: "FTS5 keyword search with BM25 ranking"
      min_lines: 50
    - path: "src/modules/search/repository.ts"
      provides: "FTS5 index management and triggers"
      min_lines: 40
    - path: "src/api/handlers/search.ts"
      provides: "Search API endpoint handler"
      exports: ["searchHandler"]
  key_links:
    - from: "src/api/router.ts"
      to: "src/api/handlers/search.ts"
      via: "Router mounting"
      pattern: "router\\.get.*search"
    - from: "src/modules/search/fts-service.ts"
      to: "src/db/index.ts"
      via: "Database access"
      pattern: "getDatabase"
    - from: "src/db/schema.sql"
      to: "posts_fts"
      via: "FTS5 virtual table"
      pattern: "CREATE VIRTUAL TABLE.*posts_fts"
---

<objective>
Implement agent-first search engine with SQLite FTS5 for keyword search and fast-fuzzy for typo tolerance.

Purpose: Enable programmatic content discovery for AI agents. Search is core to the "Reddit+StackOverflow for AI agents" vision - agents must find relevant posts efficiently.

Output: GET /api/v1/search endpoint with keyword, fuzzy, and hybrid modes. Structured JSON responses with relevance scores and metadata.
</objective>

<execution_context>
@/home/tcsenpai/.claude/get-shit-done/workflows/execute-plan.md
@/home/tcsenpai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-RESEARCH.md

# Source files to reference
@src/db/index.ts
@src/db/schema.sql
@src/types/index.ts
@src/api/router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install search dependencies and create FTS5 schema</name>
  <files>package.json, src/db/schema.sql</files>
  <action>
Install fuzzy search libraries:
```bash
cd /home/tcsenpai/coding/lattice && bun add fast-fuzzy
```

Note: fastest-levenshtein is a peer dependency of fast-fuzzy, installed automatically.

Update src/db/schema.sql - add FTS5 virtual tables and triggers:

```sql
-- Full-text search index for posts
CREATE VIRTUAL TABLE IF NOT EXISTS posts_fts USING fts5(
    id UNINDEXED,
    content,
    author_did UNINDEXED,
    tokenize = 'porter unicode61'
);

-- Full-text search index for agents (search by username patterns in content)
CREATE VIRTUAL TABLE IF NOT EXISTS agents_fts USING fts5(
    did UNINDEXED,
    public_key UNINDEXED,
    tokenize = 'porter unicode61'
);

-- Trigger: Auto-index posts on insert
CREATE TRIGGER IF NOT EXISTS posts_fts_insert AFTER INSERT ON posts BEGIN
    INSERT INTO posts_fts(id, content, author_did)
    VALUES (new.id, new.content, new.author_did);
END;

-- Trigger: Auto-update FTS on post update
CREATE TRIGGER IF NOT EXISTS posts_fts_update AFTER UPDATE ON posts BEGIN
    DELETE FROM posts_fts WHERE id = old.id;
    INSERT INTO posts_fts(id, content, author_did)
    VALUES (new.id, new.content, new.author_did);
END;

-- Trigger: Auto-delete from FTS on post delete
CREATE TRIGGER IF NOT EXISTS posts_fts_delete AFTER DELETE ON posts BEGIN
    DELETE FROM posts_fts WHERE id = old.id;
END;
```

Place these AFTER the posts table definition in schema.sql.
  </action>
  <verify>
1. Dependencies installed: `cat /home/tcsenpai/coding/lattice/package.json | grep fast-fuzzy`
2. Schema syntax valid: Database initializes without error on next start
  </verify>
  <done>fast-fuzzy installed, FTS5 virtual tables and triggers added to schema.sql</done>
</task>

<task type="auto">
  <name>Task 2: Create search module</name>
  <files>src/modules/search/index.ts, src/modules/search/fts-service.ts, src/modules/search/repository.ts</files>
  <action>
Create src/modules/search/ directory with three files:

**src/modules/search/repository.ts:**
- Import Database from better-sqlite3
- Export `rebuildPostsIndex(db)` - populates posts_fts from existing posts table
- Export `optimizeFTSIndex(db)` - runs FTS5 optimize command
- Used for initial migration and maintenance

**src/modules/search/fts-service.ts:**
- Import Database and getDatabase
- Define SearchResult interface: { id, content, authorDid, relevanceScore, snippet }
- Define SearchOptions: { mode: 'keyword' | 'fuzzy' | 'hybrid', limit: number, threshold?: number }

Functions:
- `keywordSearch(query: string, limit: number)`: Uses FTS5 MATCH with BM25 ranking
  - Sanitize query (escape quotes, remove trailing operators)
  - Use snippet() for highlighted excerpts
  - Return relevance_score as bm25() * -1 (positive score)

- `fuzzySearchPosts(query: string, options: SearchOptions)`: Uses fast-fuzzy
  - Fetch recent posts (limit 500) from database
  - Apply fast-fuzzy search with keySelector on content
  - Filter by threshold (default 0.5)
  - Return with fuzzy scores

- `hybridSearch(query: string, options: SearchOptions)`:
  - Run keyword search (limit 50)
  - Run fuzzy search (limit 50)
  - Merge results, dedupe by id
  - Re-rank by combined score
  - Return top N results

**src/modules/search/index.ts:**
- Re-export all from fts-service.ts and repository.ts
- Export main facade `searchPosts(query, options)` that routes to correct implementation
- Export types

Include FTS5 query sanitization per research pitfall:
```typescript
function sanitizeFTSQuery(query: string): string {
  // Remove trailing boolean operators
  query = query.replace(/\s+(AND|OR|NOT)\s*$/i, '');
  // Escape double quotes
  query = query.replace(/"/g, '""');
  // Remove standalone special chars
  query = query.replace(/[*]/g, '');
  // Wrap in quotes for phrase matching
  return `"${query}"`;
}
```
  </action>
  <verify>`bun run type-check` passes</verify>
  <done>Search module with FTS5 keyword search, fuzzy search, and hybrid mode implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create search API endpoint and mount in router</name>
  <files>src/api/handlers/search.ts, src/api/router.ts</files>
  <action>
**src/api/handlers/search.ts:**

Create handler following existing patterns (see posts.ts, agents.ts):

```typescript
/**
 * Search Handler
 * GET /api/v1/search - Search posts and agents
 */

import type { Request, Response, NextFunction } from "express";
import { searchPosts, SearchOptions, SearchResult } from "../../modules/search/index.js";
import { ValidationError } from "../middleware/error.js";

interface SearchAPIResponse {
  query: string;
  mode: 'keyword' | 'fuzzy' | 'hybrid';
  results: {
    posts: SearchResult[];
  };
  metadata: {
    total_results: number;
    query_time_ms: number;
    max_relevance_score: number;
  };
}

export function searchHandler(
  req: Request,
  res: Response,
  next: NextFunction
): void {
  try {
    const query = req.query.q as string;
    const mode = (req.query.mode as string) || 'hybrid';
    const limit = parseInt(req.query.limit as string, 10) || 20;

    if (!query || query.trim().length === 0) {
      throw new ValidationError("q query parameter is required");
    }

    if (query.length < 2) {
      throw new ValidationError("q must be at least 2 characters");
    }

    if (!['keyword', 'fuzzy', 'hybrid'].includes(mode)) {
      throw new ValidationError("mode must be keyword, fuzzy, or hybrid");
    }

    if (limit < 1 || limit > 100) {
      throw new ValidationError("limit must be between 1 and 100");
    }

    const startTime = Date.now();
    const results = searchPosts(query, {
      mode: mode as SearchOptions['mode'],
      limit
    });
    const queryTime = Date.now() - startTime;

    const response: SearchAPIResponse = {
      query,
      mode: mode as SearchOptions['mode'],
      results: {
        posts: results,
      },
      metadata: {
        total_results: results.length,
        query_time_ms: queryTime,
        max_relevance_score: results[0]?.relevanceScore || 0,
      },
    };

    res.json(response);
  } catch (err) {
    next(err);
  }
}
```

**Update src/api/router.ts:**

Add import:
```typescript
import { searchHandler } from "./handlers/search.js";
```

Add route (after feed, before reports):
```typescript
// Search routes (no auth required)
router.get("/search", searchHandler);
```

This makes search public (no auth) like feed, enabling easy agent access.
  </action>
  <verify>
1. `bun run type-check` passes
2. Start server and test: `curl "http://localhost:3000/api/v1/search?q=test"` returns JSON with results array
  </verify>
  <done>Search API endpoint at GET /api/v1/search with keyword, fuzzy, hybrid modes</done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes
2. Server starts without errors
3. GET /api/v1/search?q=test returns structured JSON
4. GET /api/v1/search?q=test&mode=keyword works
5. GET /api/v1/search?q=test&mode=fuzzy works
6. GET /api/v1/search?q=test&mode=hybrid works
7. Invalid query (empty, too short) returns 400 error
8. FTS5 tables exist: `SELECT name FROM sqlite_master WHERE name LIKE '%_fts'`
</verification>

<success_criteria>
- Search endpoint returns structured JSON with relevance scores
- Keyword search uses FTS5 BM25 ranking
- Fuzzy search tolerates typos (1-2 character distance)
- Hybrid mode combines both for best results
- Query sanitization prevents FTS5 syntax errors
- Response includes metadata (query_time_ms, total_results) for agent consumption
- FTS5 index automatically maintained via triggers
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-02-SUMMARY.md`
</output>
