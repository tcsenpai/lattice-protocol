---
phase: 01.1-mvp-fix-webui-openapi-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/api/openapi.ts
  - src/api/openapi-spec.ts
  - src/index.ts
  - openapi.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "All 14 existing API endpoints are documented in OpenAPI 3.0 spec"
    - "Interactive Swagger UI is accessible at /api-docs"
    - "OpenAPI spec includes authentication scheme documentation"
    - "Request/response schemas match actual API behavior"
  artifacts:
    - path: "src/api/openapi.ts"
      provides: "OpenAPI specification definition"
      min_lines: 100
    - path: "src/api/openapi-spec.ts"
      provides: "Complete schema definitions for all request/response types"
      exports: ["openApiSpec"]
    - path: "openapi.json"
      provides: "Generated OpenAPI 3.0 JSON spec file"
      contains: "openapi"
  key_links:
    - from: "src/index.ts"
      to: "src/api/openapi.ts"
      via: "Express middleware mount"
      pattern: "app\\.use.*api-docs"
    - from: "src/api/openapi-spec.ts"
      to: "src/types/index.ts"
      via: "Type imports for schema generation"
      pattern: "import.*types"
---

<objective>
Create comprehensive OpenAPI 3.0 specification for all existing Lattice Protocol API endpoints with interactive Swagger UI.

Purpose: Enable API discovery and testing for both human developers and AI agents. OpenAPI spec serves as machine-readable documentation essential for agent-first integration.

Output: `/api-docs` endpoint serving Swagger UI, `openapi.json` spec file, fully documented authentication scheme.
</objective>

<execution_context>
@/home/tcsenpai/.claude/get-shit-done/workflows/execute-plan.md
@/home/tcsenpai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-RESEARCH.md

# Source files to reference
@src/api/router.ts
@src/types/index.ts
@src/api/handlers/agents.ts
@src/api/handlers/posts.ts
@src/api/handlers/votes.ts
@src/api/handlers/feed.ts
@src/api/handlers/exp.ts
@src/api/handlers/reports.ts
@src/api/handlers/attestations.ts
@src/api/handlers/health.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install OpenAPI dependencies</name>
  <files>package.json</files>
  <action>
Install swagger-ui-express for serving interactive documentation.

```bash
cd /home/tcsenpai/coding/lattice && bun add swagger-ui-express && bun add -d @types/swagger-ui-express
```

Note: We will manually define the OpenAPI spec (not use swagger-autogen-ast) because:
1. The existing codebase uses synchronous handlers without explicit type annotations on responses
2. Manual spec ensures 100% accuracy with actual API behavior
3. Research indicated swagger-autogen-ast may need manual tweaks for custom auth (DID signatures)
  </action>
  <verify>Check package.json includes swagger-ui-express</verify>
  <done>Dependencies installed: swagger-ui-express, @types/swagger-ui-express</done>
</task>

<task type="auto">
  <name>Task 2: Create OpenAPI specification</name>
  <files>src/api/openapi-spec.ts</files>
  <action>
Create comprehensive OpenAPI 3.0 specification covering all 14 endpoints.

Structure:
- Info section with Lattice Protocol metadata
- Server definitions (localhost:3000)
- Security scheme: Custom DID signature authentication (X-DID, X-Signature, X-Timestamp headers)
- Tags: Agents, Posts, Votes, Feed, Reports, EXP, Health, Attestations
- Schemas matching src/types/index.ts:
  - Agent, Post, PostWithAuthor, Vote, FeedResponse
  - ErrorResponse, AgentEXP, SpamReport
  - Request bodies: CreatePostRequest, VoteRequest, RegisterAgentRequest

Endpoints to document (from router.ts):
1. GET /health - Health check
2. POST /agents - Register agent (body: publicKey)
3. GET /agents/:did - Get agent info
4. POST /attestations - Create attestation (auth required)
5. POST /posts - Create post (auth required, rate limited)
6. GET /posts/:id - Get post
7. DELETE /posts/:id - Delete post (auth required)
8. GET /posts/:id/replies - Get replies
9. POST /posts/:id/votes - Cast vote (auth required, rate limited)
10. GET /feed - Get feed
11. POST /reports - Report spam (auth required, rate limited)
12. GET /exp/:did - Get EXP
13. GET /exp/:did/history - Get EXP history

For each endpoint include:
- Summary and description
- Parameters (path, query)
- Request body schema
- Response schemas (200, 201, 400, 401, 403, 404, 429, 500)
- Security requirements where applicable

Export as `openApiSpec` object typed as OpenAPIV3.Document.
  </action>
  <verify>TypeScript compiles without errors: `cd /home/tcsenpai/coding/lattice && bun run type-check`</verify>
  <done>Complete OpenAPI 3.0 spec with all 14 endpoints, schemas, and security definitions</done>
</task>

<task type="auto">
  <name>Task 3: Mount Swagger UI and export spec</name>
  <files>src/api/openapi.ts, src/index.ts, openapi.json</files>
  <action>
Create src/api/openapi.ts:
- Import swagger-ui-express and openApiSpec
- Export function `setupOpenAPI(app: Express.Application)` that:
  - Mounts Swagger UI at `/api-docs`
  - Serves raw OpenAPI JSON at `/api-docs/spec.json`

Update src/index.ts:
- Import setupOpenAPI from './api/openapi.js'
- Call setupOpenAPI(app) after app creation but before mounting API router
- Add startup log: "API docs: http://localhost:${config.PORT}/api-docs"

Generate static openapi.json:
- Create a simple script or add to openapi.ts that writes the spec to ./openapi.json
- This file can be used by external tools for SDK generation

Ensure proper TypeScript module imports (.js extensions for ESM compatibility).
  </action>
  <verify>
1. Start server: `cd /home/tcsenpai/coding/lattice && timeout 5 bun run dev || true`
2. Check Swagger UI loads: The startup log should show "/api-docs" URL
3. Verify openapi.json exists: `cat /home/tcsenpai/coding/lattice/openapi.json | head -20`
  </verify>
  <done>Swagger UI serves at /api-docs, spec available at /api-docs/spec.json, openapi.json generated</done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes
2. Server starts without errors
3. http://localhost:3000/api-docs loads Swagger UI
4. All 14 endpoints visible in Swagger UI with proper schemas
5. Authentication headers documented clearly
6. openapi.json file exists in project root
</verification>

<success_criteria>
- OpenAPI 3.0 spec covers all existing API endpoints
- Swagger UI accessible at /api-docs
- Schemas match actual TypeScript types from src/types/index.ts
- DID authentication scheme documented
- External openapi.json available for tooling
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-01-SUMMARY.md`
</output>
