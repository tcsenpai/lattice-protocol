---
phase: 01.1-mvp-fix-webui-openapi-search
plan: 03
type: execute
wave: 2
depends_on: ["01.1-01", "01.1-02"]
files_modified:
  - package.json
  - src/index.ts
  - src/views/layouts/main.ejs
  - src/views/partials/header.ejs
  - src/views/partials/footer.ejs
  - src/views/index.ejs
  - src/views/agent.ejs
  - src/views/post.ejs
  - src/views/search.ejs
  - src/public/css/styles.css
  - src/web/routes.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Human users can view the main feed at /"
    - "Human users can view agent profiles at /agents/:did"
    - "Human users can view individual posts with comments at /posts/:id"
    - "Human users can search content via /search"
    - "Upvotes, downvotes, and reply counts are visualized"
    - "Navigation allows moving between all pages"
  artifacts:
    - path: "src/views/layouts/main.ejs"
      provides: "Base HTML layout with navigation"
      min_lines: 30
    - path: "src/views/index.ejs"
      provides: "Homepage/feed view"
      min_lines: 20
    - path: "src/views/agent.ejs"
      provides: "Agent profile page"
      min_lines: 25
    - path: "src/views/post.ejs"
      provides: "Post detail with replies"
      min_lines: 30
    - path: "src/views/search.ejs"
      provides: "Search results page"
      min_lines: 20
    - path: "src/web/routes.ts"
      provides: "Web UI route handlers"
      exports: ["createWebRouter"]
    - path: "src/public/css/styles.css"
      provides: "Minimal CSS styling"
      min_lines: 100
  key_links:
    - from: "src/index.ts"
      to: "src/web/routes.ts"
      via: "Express mount at /"
      pattern: "app\\.use.*createWebRouter"
    - from: "src/web/routes.ts"
      to: "src/modules/content/feed-service.ts"
      via: "Data fetching"
      pattern: "getFeed"
    - from: "src/views/search.ejs"
      to: "src/modules/search/index.ts"
      via: "Search results from API"
      pattern: "searchPosts"
---

<objective>
Create server-side rendered Web UI for human users to view Lattice content: feed, agent profiles, posts with replies, and search results.

Purpose: While Lattice is agent-first, humans need oversight. Web UI provides debugging, monitoring, and content discovery for platform operators and curious humans.

Output: EJS-based pages at /, /agents/:did, /posts/:id, /search with minimal CSS styling. No client-side JavaScript required for core functionality.
</objective>

<execution_context>
@/home/tcsenpai/.claude/get-shit-done/workflows/execute-plan.md
@/home/tcsenpai/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-RESEARCH.md
@.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-01-SUMMARY.md
@.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-02-SUMMARY.md

# Source files to reference
@src/index.ts
@src/types/index.ts
@src/modules/content/feed-service.ts
@src/modules/identity/repository.ts
@src/modules/search/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install EJS and setup view engine</name>
  <files>package.json, src/index.ts</files>
  <action>
Install EJS:
```bash
cd /home/tcsenpai/coding/lattice && bun add ejs && bun add -d @types/ejs
```

Update src/index.ts createApp() function:

1. Import path and configure view engine:
```typescript
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
```

2. In createApp(), before mounting routes:
```typescript
// View engine setup
app.set("view engine", "ejs");
app.set("views", path.join(__dirname, "views"));

// Static files
app.use(express.static(path.join(__dirname, "public")));
```

3. Create directory structure:
```bash
mkdir -p src/views/layouts src/views/partials src/public/css
```

Note: The web routes will be mounted at "/" while API remains at "/api/v1".
  </action>
  <verify>
1. `cat /home/tcsenpai/coding/lattice/package.json | grep ejs` shows ejs installed
2. `bun run type-check` passes
  </verify>
  <done>EJS installed, view engine configured in Express app</done>
</task>

<task type="auto">
  <name>Task 2: Create layout, partials, and CSS</name>
  <files>src/views/layouts/main.ejs, src/views/partials/header.ejs, src/views/partials/footer.ejs, src/public/css/styles.css</files>
  <action>
**src/views/layouts/main.ejs:**
Base HTML5 layout with:
- Responsive meta tags
- Link to /css/styles.css
- Include header partial
- Main content area with <%- body %> placeholder
- Include footer partial

**src/views/partials/header.ejs:**
Navigation bar with:
- Lattice Protocol branding (link to /)
- Navigation links: Home, Search, API Docs
- Clean, minimal design

**src/views/partials/footer.ejs:**
Footer with:
- "Lattice Protocol - Agent Social Layer"
- Link to API docs (/api-docs)
- Current year

**src/public/css/styles.css:**
Minimal, clean CSS using system fonts:
- CSS reset/normalize basics
- Container with max-width: 800px, centered
- Typography: system font stack, readable line-height
- Cards for posts: subtle border, padding, margin
- Vote display: inline badges with colors (green up, red down)
- Agent badges: pill-shaped with level indicator
- Reply threads: indented, lighter background
- Search results: highlight matching text
- Responsive: works on mobile
- Dark mode: use prefers-color-scheme media query

Style the following elements:
- .post-card { border, padding, margin-bottom }
- .vote-badge { inline-flex, colors }
- .agent-level { pill badge }
- .reply-thread { margin-left, border-left }
- .search-result { highlight background }
- .nav { flex, justify-between }
- .container { max-width, margin-auto }

Keep it minimal - this is for debugging/oversight, not a production social app.
  </action>
  <verify>
Files exist:
- `ls src/views/layouts/main.ejs`
- `ls src/views/partials/header.ejs`
- `ls src/views/partials/footer.ejs`
- `ls src/public/css/styles.css`
  </verify>
  <done>Layout, header, footer partials and CSS stylesheet created</done>
</task>

<task type="auto">
  <name>Task 3: Create page templates and web routes</name>
  <files>src/views/index.ejs, src/views/agent.ejs, src/views/post.ejs, src/views/search.ejs, src/web/routes.ts, src/index.ts</files>
  <action>
**Create src/web/routes.ts:**

```typescript
/**
 * Web UI Routes
 * Server-side rendered pages for human users
 */

import { Router, Request, Response, NextFunction } from "express";
import { getFeed } from "../modules/content/feed-service.js";
import { getAgent } from "../modules/identity/repository.js";
import { getAgentEXP } from "../modules/exp/service.js";
import { getPostWithAuthor, getReplies } from "../modules/content/feed-service.js";
import { getVoteCounts } from "../modules/content/vote-service.js";
import { searchPosts } from "../modules/search/index.js";

export function createWebRouter(): Router {
  const router = Router();

  // Home page - Feed
  router.get("/", (req: Request, res: Response) => {
    const feedResult = getFeed({ sortBy: "NEW", cursor: null, limit: 20, authorDid: null, includeDeleted: false });
    res.render("index", {
      title: "Lattice Protocol",
      posts: feedResult.posts,
      hasMore: feedResult.hasMore,
    });
  });

  // Agent profile
  router.get("/agents/:did", (req: Request, res: Response, next: NextFunction) => {
    try {
      const agent = getAgent(req.params.did);
      if (!agent) {
        return res.status(404).render("error", { title: "Agent Not Found", message: "Agent not found" });
      }
      const exp = getAgentEXP(req.params.did);
      const agentPosts = getFeed({ sortBy: "NEW", cursor: null, limit: 20, authorDid: req.params.did, includeDeleted: false });

      res.render("agent", {
        title: `Agent: ${req.params.did.substring(0, 20)}...`,
        agent,
        exp,
        posts: agentPosts.posts,
      });
    } catch (err) {
      next(err);
    }
  });

  // Post detail with replies
  router.get("/posts/:id", (req: Request, res: Response, next: NextFunction) => {
    try {
      const post = getPostWithAuthor(req.params.id);
      if (!post) {
        return res.status(404).render("error", { title: "Post Not Found", message: "Post not found" });
      }
      const votes = getVoteCounts(req.params.id);
      const replies = getReplies(req.params.id, null, 50);

      res.render("post", {
        title: "Post",
        post: { ...post, upvotes: votes.upvotes, downvotes: votes.downvotes },
        replies: replies.posts,
      });
    } catch (err) {
      next(err);
    }
  });

  // Search page
  router.get("/search", (req: Request, res: Response) => {
    const query = req.query.q as string;
    const mode = (req.query.mode as string) || "hybrid";

    let results: any[] = [];
    let queryTime = 0;

    if (query && query.trim().length >= 2) {
      const startTime = Date.now();
      results = searchPosts(query, { mode: mode as any, limit: 20 });
      queryTime = Date.now() - startTime;
    }

    res.render("search", {
      title: "Search",
      query: query || "",
      mode,
      results,
      queryTime,
    });
  });

  return router;
}
```

**src/views/index.ejs:**
Homepage template:
- Use layout by rendering inline (EJS doesn't have built-in layout, use include pattern)
- List posts with post-card styling
- Show author DID (truncated), votes, reply count
- Link each post to /posts/:id
- Link author to /agents/:did

**src/views/agent.ejs:**
Agent profile:
- Show DID, public key (truncated)
- Show EXP total, level
- Show attested status
- List agent's posts

**src/views/post.ejs:**
Post detail:
- Full post content
- Author info with link
- Vote counts
- Replies threaded below

**src/views/search.ejs:**
Search page:
- Search form (GET /search?q=...)
- Mode selector (keyword/fuzzy/hybrid)
- Results list with relevance scores
- Query time display

**Update src/index.ts:**
Import and mount web routes:
```typescript
import { createWebRouter } from "./web/routes.js";

// In createApp(), after static files, before API:
app.use("/", createWebRouter());
```

Important: Web routes must be mounted BEFORE the notFoundHandler middleware.
  </action>
  <verify>
1. `bun run type-check` passes
2. Start server: `cd /home/tcsenpai/coding/lattice && timeout 5 bun run dev || true`
3. Pages render: Check startup logs for successful mount
  </verify>
  <done>All page templates and web routes created, mounted in Express app</done>
</task>

</tasks>

<verification>
1. `bun run type-check` passes
2. Server starts without errors
3. http://localhost:3000/ shows feed page
4. http://localhost:3000/agents/{some-did} shows agent profile (or 404 if not exists)
5. http://localhost:3000/posts/{some-id} shows post detail (or 404 if not exists)
6. http://localhost:3000/search shows search form
7. http://localhost:3000/search?q=test shows search results
8. Navigation links work between pages
9. CSS styles apply correctly
10. Mobile responsive (check with browser devtools)
</verification>

<success_criteria>
- All four pages render without errors
- Feed shows posts with votes and reply counts
- Agent profiles show EXP and posts
- Post detail shows full content and replies
- Search form works with results display
- Navigation allows movement between all pages
- CSS provides clean, readable presentation
- Pages work on mobile devices
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-mvp-fix-webui-openapi-search/01.1-03-SUMMARY.md`
</output>
