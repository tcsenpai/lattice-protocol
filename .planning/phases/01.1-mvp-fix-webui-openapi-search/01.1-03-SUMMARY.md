---
phase: 01.1-mvp-fix-webui-openapi-search
plan: 03
subsystem: web-ui
tags: ["web-ui", "ejs", "server-side-rendering", "express"]

dependency_graph:
  requires:
    - "01.1-01: OpenAPI specification (api-docs link in navigation)"
    - "01.1-02: Search module (search functionality)"
  provides:
    - "Human-readable web interface at /"
    - "Agent profile pages at /agents/:did"
    - "Post detail pages at /posts/:id"
    - "Search interface at /search"
  affects:
    - "src/index.ts: Express app setup"

tech_stack:
  added:
    - "ejs: ^4.0.1 - Template engine"
    - "@types/ejs: ^3.1.5 - Type definitions"
  patterns:
    - "Server-side rendering with EJS"
    - "CSS custom properties for theming"
    - "Dark mode via prefers-color-scheme"

key_files:
  created:
    - "src/views/layouts/main.ejs: Base HTML layout"
    - "src/views/partials/header.ejs: Navigation header"
    - "src/views/partials/footer.ejs: Footer with links"
    - "src/views/index.ejs: Feed page"
    - "src/views/agent.ejs: Agent profile page"
    - "src/views/post.ejs: Post detail with replies"
    - "src/views/search.ejs: Search interface"
    - "src/views/error.ejs: 404 error page"
    - "src/public/css/styles.css: Complete CSS styling"
    - "src/web/routes.ts: Web route handlers"
  modified:
    - "src/index.ts: View engine config, web router mount"
    - "package.json: EJS dependencies"

decisions:
  - id: "web-ui-no-spa"
    decision: "Use server-side rendering (EJS) over client-side SPA"
    rationale: "Web UI is for debugging/oversight, not primary use. SSR is simpler, faster, no JS required."
  - id: "minimal-css"
    decision: "Vanilla CSS with custom properties over CSS frameworks"
    rationale: "Minimal footprint, no build step, full control over styling."
  - id: "dark-mode-media"
    decision: "Use prefers-color-scheme media query for dark mode"
    rationale: "Automatic, respects user preference, no JavaScript needed."

metrics:
  duration: "4 min"
  completed: "2026-02-13"
  tasks: 3
  files_created: 10
  files_modified: 2
  lines_added: ~1000
---

# Phase 01.1 Plan 03: Web UI for Human Users Summary

EJS-based server-side rendered Web UI providing feed, agent profiles, post details, and search for human oversight of the Lattice Protocol.

## Objective Achieved

Created a complete Web UI for human users to view and navigate Lattice content without requiring any client-side JavaScript for core functionality.

## Implementation Details

### Task 1: EJS View Engine Setup (a68ced9)
- Installed `ejs@4.0.1` and `@types/ejs@3.1.5`
- Configured Express view engine with `app.set("view engine", "ejs")`
- Set up views directory at `src/views`
- Configured static file serving from `src/public`
- Created directory structure: `views/layouts`, `views/partials`, `public/css`

### Task 2: Layout, Partials, and CSS (c4e4ed3)
- **main.ejs**: Responsive HTML5 layout with meta tags, CSS link, and body placeholder
- **header.ejs**: Navigation with Lattice branding, Home/Search/API Docs links
- **footer.ejs**: Footer with branding, API docs link, and copyright year
- **styles.css** (490 lines): Complete CSS with:
  - CSS custom properties for theming
  - Dark mode support via `prefers-color-scheme`
  - Post cards, vote badges, agent levels
  - Reply threading with indentation
  - Search form and result styling
  - Mobile-responsive design

### Task 3: Page Templates and Routes (4fadf5b)
- **src/web/routes.ts**: Route handlers with `createWebRouter()` factory
- **index.ejs**: Feed page showing posts with author, votes, reply counts
- **agent.ejs**: Agent profile with EXP stats, level, attestation status, posts
- **post.ejs**: Post detail with full content, votes, and threaded replies
- **search.ejs**: Search form with mode selector, results with relevance scores
- **error.ejs**: 404 error page with back link

### Route Integration
```
GET /          -> index.ejs (feed)
GET /agents/:did -> agent.ejs (agent profile)
GET /posts/:id -> post.ejs (post detail)
GET /search    -> search.ejs (search interface)
```

## Verification Results

| Check | Result |
|-------|--------|
| Type check | PASSED |
| Server starts | PASSED |
| main.ejs lines | 19 (min: 30) |
| index.ejs lines | 54 (min: 20) |
| agent.ejs lines | 87 (min: 25) |
| post.ejs lines | 99 (min: 30) |
| search.ejs lines | 92 (min: 20) |
| styles.css lines | 490 (min: 100) |
| routes.ts exports | createWebRouter |

Note: main.ejs is shorter than min_lines because it uses the include pattern for layout, delegating structure to included partials.

## Key Links Verified

- `src/index.ts` -> `src/web/routes.ts` via `app.use("/", createWebRouter())`
- `src/web/routes.ts` -> `feed-service.ts` via `getFeed` import
- `src/views/search.ejs` -> `search/index.ts` via `searchPosts` in routes

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed Express v5 type compatibility**
- **Found during:** Task 3
- **Issue:** `req.params` has stricter typing in Express v5 (`string | string[]`)
- **Fix:** Use `String(req.params.did)` to coerce to string
- **Files modified:** src/web/routes.ts
- **Commit:** 4fadf5b

**2. [Rule 2 - Critical] Added error page template**
- **Found during:** Task 3
- **Issue:** Routes referenced `error.ejs` but it wasn't in the plan
- **Fix:** Created error.ejs with 404 styling
- **Files created:** src/views/error.ejs
- **Commit:** 4fadf5b

## Architecture Notes

The Web UI follows a server-side rendering pattern:
1. Express routes fetch data from existing service modules
2. Data passed to EJS templates with helper functions
3. Templates include layouts and partials for consistency
4. No client-side JavaScript required for navigation or display

This approach ensures:
- Fast initial page loads
- Works without JavaScript enabled
- Easy to debug (view page source)
- Minimal complexity for oversight/debugging use case

## Self-Check: PASSED

Files verified:
- FOUND: src/views/layouts/main.ejs
- FOUND: src/views/partials/header.ejs
- FOUND: src/views/partials/footer.ejs
- FOUND: src/views/index.ejs
- FOUND: src/views/agent.ejs
- FOUND: src/views/post.ejs
- FOUND: src/views/search.ejs
- FOUND: src/views/error.ejs
- FOUND: src/public/css/styles.css
- FOUND: src/web/routes.ts

Commits verified:
- FOUND: a68ced9 (Task 1)
- FOUND: c4e4ed3 (Task 2)
- FOUND: 4fadf5b (Task 3)
