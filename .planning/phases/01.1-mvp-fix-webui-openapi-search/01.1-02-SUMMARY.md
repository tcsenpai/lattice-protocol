---
phase: 01.1-mvp-fix-webui-openapi-search
plan: 02
subsystem: search
tags: [fts5, fuzzy-search, api, agent-first]
dependency-graph:
  requires:
    - src/db/index.ts
    - src/api/router.ts
  provides:
    - src/modules/search/*
    - src/api/handlers/search.ts
    - GET /api/v1/search
  affects:
    - src/db/schema.sql
tech-stack:
  added:
    - fast-fuzzy: "Typo-tolerant fuzzy search with scoring"
    - SQLite FTS5: "Full-text search with BM25 ranking"
  patterns:
    - Module facade pattern (search/index.ts)
    - Query sanitization for FTS5 safety
    - Hybrid search combining keyword and fuzzy
key-files:
  created:
    - src/modules/search/index.ts
    - src/modules/search/fts-service.ts
    - src/modules/search/repository.ts
    - src/api/handlers/search.ts
  modified:
    - package.json
    - src/db/schema.sql
    - src/api/router.ts
decisions:
  - "FTS5 with porter stemmer for keyword search"
  - "fast-fuzzy over fastest-levenshtein for better scoring"
  - "Hybrid mode as default for best results"
  - "No auth on search endpoint for easy agent access"
metrics:
  duration: 3 minutes
  completed: 2026-02-13
  tasks: 3
  files_created: 4
  files_modified: 3
---

# Phase 1.1 Plan 02: Search Engine Summary

Agent-first search engine with SQLite FTS5 keyword search and fast-fuzzy typo tolerance.

## One-liner

FTS5 keyword search with BM25 ranking, fast-fuzzy for typo tolerance, hybrid mode combining both.

## What Was Built

### Search Module (`src/modules/search/`)

| File | Purpose | Lines |
|------|---------|-------|
| index.ts | Module facade with searchPosts() | 53 |
| fts-service.ts | FTS5 + fuzzy search implementation | 232 |
| repository.ts | FTS index management | 63 |

### Search API (`src/api/handlers/search.ts`)

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| /api/v1/search | GET | None | Search posts by keyword |

Query parameters:
- `q` (required): Search query (min 2 chars)
- `mode` (optional): `keyword`, `fuzzy`, or `hybrid` (default)
- `limit` (optional): 1-100 results (default 20)

### FTS5 Schema Updates

```sql
CREATE VIRTUAL TABLE posts_fts USING fts5(
    id UNINDEXED,
    content,
    author_did UNINDEXED,
    tokenize = 'porter unicode61'
);
```

Auto-sync triggers maintain the index on INSERT, UPDATE, DELETE.

## Search Modes

1. **keyword**: FTS5 MATCH with BM25 ranking. Best for exact terms.
2. **fuzzy**: fast-fuzzy with threshold 0.5. Best for typo tolerance.
3. **hybrid**: Combines both, boosts keyword matches 1.5x. Best overall.

## API Response Format

```json
{
  "query": "search term",
  "mode": "hybrid",
  "results": {
    "posts": [
      {
        "id": "01HXY...",
        "content": "Full post content",
        "authorDid": "did:key:...",
        "relevanceScore": 2.45,
        "snippet": "...highlighted <mark>term</mark>..."
      }
    ]
  },
  "metadata": {
    "total_results": 15,
    "query_time_ms": 12,
    "max_relevance_score": 2.45
  }
}
```

## Commits

| Hash | Description |
|------|-------------|
| 07b4407 | feat(01.1-02): add fast-fuzzy dependency and FTS5 schema |
| f30dc74 | feat(01.1-02): implement search module with FTS5 and fuzzy matching |
| cab46ef | feat(01.1-02): add search API endpoint at GET /api/v1/search |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

- [x] `bun run type-check` passes
- [x] Server starts without errors
- [x] GET /api/v1/search?q=test returns structured JSON
- [x] GET /api/v1/search?q=test&mode=keyword works
- [x] GET /api/v1/search?q=test&mode=fuzzy works
- [x] GET /api/v1/search?q=test&mode=hybrid works
- [x] Invalid query (empty) returns 400 error
- [x] FTS5 tables exist in database

## Self-Check: PASSED

### Files Created - Verified:
- FOUND: /home/tcsenpai/coding/lattice/src/modules/search/index.ts
- FOUND: /home/tcsenpai/coding/lattice/src/modules/search/fts-service.ts
- FOUND: /home/tcsenpai/coding/lattice/src/modules/search/repository.ts
- FOUND: /home/tcsenpai/coding/lattice/src/api/handlers/search.ts

### Commits - Verified:
- FOUND: 07b4407
- FOUND: f30dc74
- FOUND: cab46ef
