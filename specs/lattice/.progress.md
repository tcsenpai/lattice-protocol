---
spec: lattice
basePath: ./specs/lattice
phase: implement
task: 2/42
updated: 2026-02-13
---

# Progress: lattice

## Original Goal

Implement the complete Lattice Protocol as described in the protocol spec document — a social coordination layer for autonomous AI agents with cryptographic identity, EXP-based karma system (replacing LATT token), and rate-limiting anti-spam. This covers all phases: Core Protocol MVP (DID registration, EXP tracking, rate limiting, basic spam detection), EXP & Governance, Federation, and Advanced Features (MCP server, MoltSpeak integration, agent APIs, ML-based spam detection).

## Completed Tasks

- ✅ Initial research phase (2026-02-12)
- ✅ Economic model revision: LATT token → EXP karma system (2026-02-13)
- ✅ Resolved open questions: MoltSpeak, slashing, content permanence
- [x] 1.1 Initialize Node.js project with TypeScript - feat(scaffold): initialize lattice protocol with typescript
- [x] 1.2 Create SQLite database schema - feat(db): add sqlite schema and migration runner
- [x] 1.3 Create shared types and utilities - bdebb4e
- [x] 1.4 Implement DID service with did:key support - feat(identity): implement did:key service with ed25519
- [x] 1.5 Implement agent repository - 963e764
- [x] 1.6 Implement attestation service - feat(identity): implement attestation service with limits
- [x] 1.7 Implement EXP repository - feat(exp): implement exp repository with history
- [x] 1.8 Implement level calculator - feat(exp): implement logarithmic level calculator
- [x] 1.9 Implement rate limiter - 8547e63
- [x] 1.11 Implement SimHash algorithm - 053a3b6
- [x] 1.13 Implement spam service - feat(spam): implement content spam detection service
- [x] 1.14 Implement spam reporting - 2392398
- [x] 1.15 Implement post repository - feat(content): implement post repository
- [x] 1.16 Implement post service - feat(content): implement post service with spam integration

## Current Task

Awaiting next task

## Design Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Economic Model | EXP karma (no token) | No regulatory risk, simpler, proven at scale |
| MoltSpeak Protocol | CBOR-based binary messaging | Efficient, well-supported |
| Slashing | Progressive: -50 to -1000 EXP | Severity-based escalation |
| Content Permanence | **Permanent** with soft-delete | Accountability, archive integrity |
| Appeals | 3-member high-EXP jury | Majority vote, 50% restoration |

## Learnings

- Task Planning: 42 total tasks across 5 phases (POC, Refactor, Test, Quality, PR)
- POC-first approach: 25 tasks in Phase 1 to validate core flow before polish
- Quality checkpoints (V1-V10) inserted every 2-3 tasks throughout all phases
- Dependencies: Identity -> EXP -> Spam -> Content -> API (linear core path)
- Parallel opportunity: SimHash and Entropy analyzers are independent
- Risk: DID signature verification is critical path - test early (task 1.4)
- SimHash implementation is CPU-bound - may need optimization if >50ms
- Cursor-based pagination using ULID enables O(1) feed queries
- POC test script (scripts/poc-test.ts) validates end-to-end flow
- Minimal testing: Only 3 unit test files for critical algorithms (level, simhash, entropy)
- W3C DID Core v1.0 is stable; v1.1 is experimental - use v1.0
- `did:key` ideal for MVP (zero infra), migrate to `did:ethr` for production
- Base L2 is best choice for EXP snapshot anchoring
- Reddit-style karma proven at 500M+ users scale
- EXP-based rate limiting achieves same spam deterrence as token fees
- Rate limits: Level 0-5 = 1 post/hr, Level 31+ = 60 posts/hr
- SimHash efficient for duplicate/spam detection
- MCP TypeScript SDK is production-ready with 24K+ dependents
- Human attestation gives +100 EXP (Level 20 immediately)
- Progressive slashing with cooldowns more effective than flat penalties
- Requirements Phase: MVP scoped to 9 user stories, 15 functional requirements
- Dual user personas confirmed: agents (posting) + developers (integration)
- Success criteria triad: <1% spam, agent adoption, MCP-ready API
- 3-report threshold for confirmed spam chosen as community moderation baseline
- Shannon entropy <2.0 useful as low-quality content signal
- Grace period and vouch system marked as "Could" to enable fast MVP iteration
- Design Phase: Modular monolith with 5 modules (Identity, EXP, Content, Spam, API)
- better-sqlite3 chosen over native node:sqlite for sync API and TypeScript support
- DID signature per-request pattern: stateless auth, no session management needed
- Sliding window rate limiting in SQLite sufficient for MVP (no Redis required)
- ULID for IDs: sortable, URL-safe, compact - better than UUID for feed pagination
- Cursor-based pagination O(1) vs OFFSET O(n) - critical for feed performance
- SQLite WAL mode enables concurrent reads during writes
- SimHash with 64-bit fingerprints + >95% threshold provides good duplicate detection
- Anti-replay protection: timestamp ±5min + signature dedup cache (10min TTL)
- pnpm v10+ requires explicit onlyBuiltDependencies in package.json for native modules (better-sqlite3)
- @noble/ed25519 v3.x API: use `verifyAsync`, `signAsync`, `getPublicKeyAsync`, `utils.randomSecretKey` (not the sync versions or v2 names)

## Blockers

- None currently

## Interview Responses

### Requirements Interview (from requirements.md)
- Primary users: Both agents and developers (AI agents for posting, developers for integration)
- Priority tradeoffs: Speed of delivery (Get MVP working fast, iterate later)
- Success criteria: All of the above (working spam prevention, agent adoption, MCP integration)
- Additional requirements context: No additional context needed

### Design Interview (from design.md)
- Architecture style: Modular Monolith (single deployable with clean module boundaries)
- Technology constraints: Node.js + TypeScript + SQLite (better-sqlite3, minimal dependencies)
- Auth pattern: DID Signature per Request (Ed25519, stateless)

### Tasks Interview (from tasks.md)
- Testing depth: Minimal - POC only, add tests later
- Deployment approach: Standard CI/CD pipeline
- Execution priority: Ship fast - POC first, polish later

## Next

Task 1.17 Implement vote service
